# BUG-040: Attachment Validation Failing in full-test.sh

## Status
- **Reported**: 2025-08-13
- **Priority**: high
- **Severity**: major

## Overview
Validation of attachments is failing when running the full-test.sh script, indicating issues with attachment processing or validation logic that prevent successful testing and deployment.

## Reproduction Steps
1. Run the full-test.sh script
2. Observe attachment validation step
3. Notice validation failures
4. Test execution may halt or report errors

## Expected Behavior
Attachment validation should pass during full-test.sh execution, confirming that:
- Attachments are properly extracted and stored
- Attachment files match expected content and hashes
- Validation logic correctly verifies attachment integrity
- All attachment-related tests pass successfully

## Actual Behavior
Attachment validation fails during full-test.sh execution with 11 specific violations:

**Validation Report:**
```
Validation Report for: /home/phillipgreenii/Projects/mobilecombackup/tmp/full-test
------------------------------------------------------------
âœ— Found 11 violation(s)

unknown_format (5):
  attachments/2a/2ab99179bbaeb53192c1970d76104758f6fd7a9b83629c992d97ded0a9f683dc: Unknown or unrecognized file format
  attachments/70/705548551f8390d89b37105ef52e3e1d471688cd32552dc66e2e4c8f47b17341: Unknown or unrecognized file format  
  attachments/8a/8a5e04f166005fb41adac81c0629502f4405322e511d03023397c0fd8fa76828: Unknown or unrecognized file format
  attachments/b7/b7d62476a0e6f0fa32ede9fd2a8035c59858bda4629891d2fd9e0957c023cd4e: Unknown or unrecognized file format
  attachments/c9/c975c178bfd3cda6fd258dee7b90548990e80c47a111c21b39c754e3aa7ad079: Unknown or unrecognized file format

orphaned_attachment (6):
  attachments/2a/2ab99179bbaeb53192c1970d76104758f6fd7a9b83629c992d97ded0a9f683dc: Orphaned attachment not referenced by any message (10 bytes)
  attachments/70/705548551f8390d89b37105ef52e3e1d471688cd32552dc66e2e4c8f47b17341: Orphaned attachment not referenced by any message (12 bytes)
  attachments/8a/8a5e04f166005fb41adac81c0629502f4405322e511d03023397c0fd8fa76828: Orphaned attachment not referenced by any message (42 bytes)
  attachments/b7/b7d62476a0e6f0fa32ede9fd2a8035c59858bda4629891d2fd9e0957c023cd4e: Orphaned attachment not referenced by any message (20 bytes)
  attachments/c9/c975c178bfd3cda6fd258dee7b90548990e80c47a111c21b39c754e3aa7ad079: Orphaned attachment not referenced by any message (59 bytes)
  attachments/e3/e37b1a09d9512c9f8741292195fb27b9f6c0708ca844e4172ee2db589a4261df: Orphaned attachment not referenced by any message (6460 bytes)
```

## Environment
- Version: Current development branch
- Test environment: As configured in full-test.sh
- Related to attachment processing functionality

## Root Cause Analysis
### Investigation Notes
Need to investigate the specific failure points in attachment validation:
- Check attachment extraction process
- Verify hash calculation and storage
- Review validation logic for correctness
- Examine test data and expectations

### Root Cause
**Confirmed Issues:**
1. **Unknown File Formats**: 5 attachments have unrecognized file formats that the validation system cannot identify
2. **Orphaned Attachments**: 6 attachments (including the 5 unknown format files plus 1 additional) are not referenced by any message

**Analysis:**
- Small file sizes (10-59 bytes, except one 6460-byte file) suggest these may be text content incorrectly extracted as binary attachments
- This aligns with FEAT-039's goal to limit extraction to binary types only
- Recent attachment extraction changes may have introduced these orphaned text extractions
- The validation system correctly identifies these as problems but the extraction system is creating them

## Fix Approach
1. **Investigate Extracted Files**: Examine the 11 problematic attachment files to determine their actual content types
2. **Review Extraction Logic**: Check why text content is being extracted as binary attachments
3. **Fix Content Type Detection**: Ensure only proper binary types are extracted (relates to FEAT-039)
4. **Clean Orphaned References**: Remove any message references to improperly extracted content
5. **Update Test Data**: Ensure test data expectations match corrected behavior

### Acceptance Criteria
- `./full-test.sh` completes with zero validation violations
- No "unknown_format" errors in validation output
- No "orphaned_attachment" errors in validation output
- Only legitimate binary attachments are extracted to filesystem

## Tasks
- [ ] Examine the 11 failing attachment files to determine actual content (text vs binary)
- [ ] Review extraction logic in pkg/sms/extractor.go for content type detection
- [ ] Implement proper content type filtering to prevent text extraction (relates to FEAT-039)
- [ ] Fix message references to prevent orphaned attachments
- [ ] Update file format detection to handle legitimate binary types
- [ ] Clean up incorrectly extracted text files from test repositories
- [ ] Run `./full-test.sh` to verify zero validation violations
- [ ] Ensure all attachment validation steps pass (lines 17, 23, 47 in full-test.sh)

## Testing
### Regression Tests
- Run full-test.sh to ensure attachment validation passes
- Test attachment extraction with various file types
- Verify attachment hash calculation and validation

### Verification Steps
1. Execute full-test.sh script successfully without attachment validation failures
2. Verify all attachment-related functionality works correctly
3. Confirm attachment files are properly extracted and validated
4. Ensure no regression in other test areas

## Workaround
Temporarily skip attachment validation in full-test.sh if needed to unblock other testing, but this should be addressed promptly as it indicates functional issues.

## Related Issues
- Related features: FEAT-012 (Extract Attachments), FEAT-034 (Fix Attachment Extraction), FEAT-039 (Limit Attachment Extraction)
- Code locations: pkg/attachments/, full-test.sh script
- Testing: Integration test suite

## Notes
This is a high-priority bug as it prevents successful testing and may indicate functional problems with attachment processing. Should be investigated and fixed promptly to maintain testing reliability and ensure attachment functionality works correctly.