# BUG-051: XML Parsing DoS Vulnerability - Missing Size Limits

## Status
- **Reported**: 2025-01-14
- **Priority**: critical
- **Severity**: major

## Overview
XML parsing in `pkg/calls/xml_reader.go` and `pkg/sms/xml_reader.go` lacks size limits, potentially allowing denial of service attacks through large or malformed XML files that consume excessive memory.

## Reproduction Steps
1. Create extremely large XML file (multi-GB)
2. Attempt to parse with current XML readers
3. Observe potential memory exhaustion

## Expected Behavior
XML parsing should have reasonable size limits to prevent memory exhaustion attacks.

## Actual Behavior
No size limits on XML parsing could lead to out-of-memory conditions.

## Environment
- All versions
- All platforms

## Root Cause Analysis
### Root Cause
XML parsers don't implement size limits or resource constraints, making them vulnerable to resource exhaustion attacks.

## Fix Approach
Implement size-limited readers for XML parsing using io.LimitedReader with configurable limits:

**Default Size Limits:**
- XML files: 500MB (typical mobile backup files are much smaller)
- Individual message processing: 10MB per SMS/MMS
- Streaming operations: Apply limit at file reader level

**Configuration:**
- Command-line flags: `--max-xml-size=500MB`, `--max-message-size=10MB`
- Add to ImportOptions struct for propagation
- Future: Support in configuration file

**Implementation Strategy:**
```go
// Apply at file open level
file, err := os.Open(filePath)
limitedReader := io.LimitedReader{R: file, N: maxXMLSize}
decoder := xml.NewDecoder(limitedReader)
```

**Error Handling:**
```go
type FileSizeLimitExceededError struct {
    Filename string
    Limit    int64
    Attempted int64 // If available from io.LimitedReader
}

func (e *FileSizeLimitExceededError) Error() string {
    return fmt.Sprintf("file size limit exceeded for %s: limit %d bytes, attempted %d bytes", 
        filepath.Base(e.Filename), e.Limit, e.Attempted)
}
```

**Size Parsing:**
- Support human-readable formats: `500MB`, `500M`, `524288000` (bytes)
- Implement `ParseSize(string) (int64, error)` function
- Default units: bytes (no suffix), MB, GB

**Configuration Integration:**
```go
// Add to ImportOptions struct
type ImportOptions struct {
    // ... existing fields ...
    MaxXMLSize     int64  // Default: 500MB  
    MaxMessageSize int64  // Default: 10MB
}

// Command flag parsing
importCmd.Flags().StringVar(&maxXMLSizeStr, "max-xml-size", "500MB", "Maximum XML file size")
importCmd.Flags().StringVar(&maxMessageSizeStr, "max-message-size", "10MB", "Maximum message size")
```

## Tasks
### Phase 1: Configuration and Error Handling
- [ ] Implement `ParseSize(string) (int64, error)` function to handle human-readable sizes
- [ ] Define `FileSizeLimitExceededError` struct with filename, limit, attempted fields
- [ ] Add command-line flags with string parsing: `--max-xml-size` and `--max-message-size`
- [ ] Add `MaxXMLSize` and `MaxMessageSize` fields to ImportOptions struct
- [ ] Set default limits: 524288000 bytes (500MB) for XML files, 10485760 bytes (10MB) for messages

### Phase 2: Implementation
- [ ] Update `pkg/calls/xml_reader.go` to use io.LimitedReader
- [ ] Update `pkg/sms/xml_reader.go` to use io.LimitedReader  
- [ ] Apply limits at file reader level before XML decoder creation
- [ ] Implement graceful error handling for size limit exceeded
- [ ] Ensure streaming operations respect limits

### Phase 3: Testing and Documentation
- [ ] Create test data generator at `testdata/generate_large_xml.go` with features:
  - Generate valid XML of specified sizes (1MB, 100MB, 500MB, 1GB)
  - Support both calls.xml and sms.xml formats with realistic data
- [ ] Write unit tests for `ParseSize` function with various input formats
- [ ] Write unit tests for size limit enforcement at boundary conditions (499MB, 500MB, 501MB)
- [ ] Add integration tests with oversized files using generated test data
- [ ] Create memory monitoring test using `runtime.ReadMemStats` to verify bounded usage
- [ ] Update command help text and CLAUDE.md with new configuration options

## Testing
### Regression Tests
- Test normal-sized files are processed correctly (under 100MB)
- Test oversized files are rejected appropriately (over 500MB)
- Test boundary conditions (files at exactly 500MB limit)
- Test very large individual messages (over 10MB)
- Test mixed scenarios (some files under/over limits)

### Test Data Generation
- Script to generate XML files of specific sizes
- Test files: 1MB, 100MB, 499MB, 500MB, 501MB, 1GB
- Malformed XML at various file sizes

### Verification Steps
1. Create test XML files of various sizes using generation script
2. Verify size limits are enforced at correct thresholds
3. Test error handling provides clear messages without path exposure
4. Monitor memory usage during processing (should not exceed ~100MB buffer)
5. Verify processing continues with remaining files after size limit hit
6. Test command-line flag configuration works correctly

## Related Issues
- Files affected: pkg/calls/xml_reader.go, pkg/sms/xml_reader.go
- Source: CODE_IMPROVEMENT_REPORT.md item #3

## Notes
Consider making size limits configurable through command-line flags or configuration file. Default limits should be reasonable for typical mobile backup files.