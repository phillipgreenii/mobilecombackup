# BUG-055: XML External Entity (XXE) vulnerability in XML parsers

## Status
- **Reported**: 2025-08-18
- **Fixed**: 
- **Priority**: critical
- **Severity**: blocker

## Overview
All XML parsing code in the codebase uses `xml.NewDecoder()` without XXE protection, enabling XML External Entity attacks that can lead to file disclosure, Server-Side Request Forgery (SSRF), and Denial of Service attacks.

## Reproduction Steps
1. Create malicious XML file with external entity:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<foo>&xxe;</foo>
```
2. Process this file through any XML reader in the application
3. Observe that external entities are resolved and sensitive files can be accessed

## Expected Behavior
XML parsers should disable external entity resolution and DTD processing to prevent XXE attacks.

## Actual Behavior
XML parsers resolve external entities, potentially exposing sensitive files and enabling SSRF attacks.

## Environment
- Version: current main branch
- OS: All supported platforms
- Go version: All versions
- Affects all XML parsing functionality

## Root Cause Analysis
### Investigation Notes
Found 8+ instances of `xml.NewDecoder()` without XXE protection:
- `pkg/calls/xml_reader.go:157, 264, 314`
- `pkg/sms/xml_reader.go:65, 767`
- `pkg/importer/calls.go:227`
- `pkg/autofix/autofix.go:698`
- Test files and other locations

### Root Cause
Go's `xml.NewDecoder()` enables external entity resolution by default. No security wrapper is used to disable this dangerous functionality.

## Fix Approach
1. Create secure XML decoder wrapper in `pkg/security/xml.go`
2. Replace all `xml.NewDecoder()` calls with secure wrapper
3. Add regression tests for XXE protection
4. Update documentation with secure XML parsing guidelines

## Tasks
- [ ] Create secure XML decoder wrapper function
- [ ] Audit all xml.NewDecoder usage (8+ instances found)
- [ ] Replace unsafe calls with secure wrapper
- [ ] Add XXE protection regression tests
- [ ] Verify fix prevents XXE attacks
- [ ] Add security documentation for XML parsing
- [ ] Add linting rule to prevent future unsafe XML parsing

## Testing
### Regression Tests
- Test that external entities are not resolved
- Test that DTD processing is disabled
- Test with various XXE attack payloads
- Verify functionality still works with legitimate XML

### Verification Steps
1. Run security tests with XXE payloads
2. Verify legitimate XML processing still works
3. Confirm no external network requests made during XML parsing
4. Test file disclosure prevention

## Workaround
Currently no workaround available - avoid processing untrusted XML until fixed.

## Related Issues
- Related to general security hardening
- May relate to input validation improvements
- Code locations: All XML parsing files (8+ instances)

## Notes
This is a critical security vulnerability that should be addressed immediately before processing any untrusted XML input. The fix should maintain backwards compatibility while adding security protections.