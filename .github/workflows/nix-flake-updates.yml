# .github/workflows/nix-flake-updates.yml
# Weekly Nix flake updates
#
# This workflow updates Nix flake inputs (nixpkgs, flake-utils) and creates PRs
# when updates are available. Complements dependabot and devbox-updates.
#
# Schedule: Weekly on Tuesday at 09:00 UTC (matching dependabot and devbox)

name: Nix Flake Updates

on:
  schedule:
    # Run weekly on Tuesday at 09:00 UTC
    - cron: '0 9 * * 2'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-flake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Update Nix flake
        id: update-flake
        run: |
          echo "Updating Nix flake inputs..."

          # Capture current lock file hash
          BEFORE_HASH=$(sha256sum flake.lock | cut -d' ' -f1)

          # Update flake inputs (nixpkgs, flake-utils, etc.)
          nix flake update

          # Capture new lock file hash
          AFTER_HASH=$(sha256sum flake.lock | cut -d' ' -f1)

          # Check if flake.lock was modified
          if [ "$BEFORE_HASH" = "$AFTER_HASH" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates available"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates found!"

            # Show what changed
            echo "Changes in flake.lock:"
            git diff flake.lock
          fi

      - name: Verify flake still builds
        if: steps.update-flake.outputs.has_updates == 'true'
        run: |
          echo "Verifying updated flake builds successfully..."
          nix flake check --show-trace

      - name: Create Pull Request
        if: steps.update-flake.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "deps(nix): update flake inputs"
          title: "deps(nix): update flake inputs"
          body: |
            ## Nix Flake Updates

            This PR updates Nix flake inputs to their latest versions.

            ### What changed
            - Updated flake inputs in `flake.lock`
            - Inputs include: nixpkgs, flake-utils

            ### Verification
            - âœ… Flake builds successfully with `nix flake check`
            - âœ… All quality checks pass

            ### How to review
            1. Check the diff in `flake.lock`
            2. Review flake input version changes
            3. Verify CI passes
            4. Test locally with:
               ```bash
               nix flake check
               nix build
               nix run . -- --version
               ```

            ### Next steps
            - [ ] Review flake.lock changes
            - [ ] Verify nix build works
            - [ ] Merge when CI passes

            ---
            ðŸ¤– Auto-generated by nix-flake-updates workflow
          branch: deps/nix-flake-updates
          delete-branch: true
          labels: dependencies,nix,flake
          assignees: phillipgreenii
          reviewers: phillipgreenii
