# .github/workflows/devbox-updates.yml
# Weekly devbox package updates
#
# This workflow checks for updates to devbox packages and creates PRs
# when updates are available. Complements dependabot for Go and GitHub Actions.
#
# Schedule: Weekly on Tuesday at 09:00 UTC (matching dependabot)

name: Devbox Package Updates

on:
  schedule:
    # Run weekly on Tuesday at 09:00 UTC
    - cron: '0 9 * * 2'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-devbox:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Devbox
        uses: jetify-com/devbox-install-action@v0.14.0
        with:
          enable-cache: true

      - name: Check for devbox updates
        id: check-updates
        run: |
          echo "Checking for devbox package updates..."

          # Capture current package versions
          devbox version list > /tmp/before-versions.txt || true

          # Update devbox packages
          devbox update

          # Check if devbox.json was modified
          if git diff --quiet devbox.json devbox.lock; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates available"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates found!"
          fi

      - name: Create Pull Request
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "deps(devbox): update devbox packages"
          title: "deps(devbox): update devbox packages"
          body: |
            ## Devbox Package Updates

            This PR updates devbox packages to their latest versions.

            ### What changed
            - Updated packages in `devbox.json` and `devbox.lock`

            ### How to review
            1. Check the diff in `devbox.json` and `devbox.lock`
            2. Review package version changes
            3. Verify CI passes
            4. Test locally with `devbox shell` and `devbox run ci`

            ### Next steps
            - [ ] Review package version changes
            - [ ] Run full CI locally: `devbox run ci`
            - [ ] Merge when CI passes

            ---
            ðŸ¤– Auto-generated by devbox-updates workflow
          branch: deps/devbox-updates
          delete-branch: true
          labels: dependencies,devbox
          assignees: phillipgreenii
          reviewers: phillipgreenii
