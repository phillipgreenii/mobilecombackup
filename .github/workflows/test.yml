on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

name: run tests
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Required for version detection with git history
      - name: Install devbox
        uses: jetify-com/devbox-install-action@v0.14.0
      - name: Extract version
        id: version
        run: |
          # Extract base version and build dev version string for CI builds
          BASE_VERSION=$(cat VERSION | sed 's/-dev$//')
          GIT_HASH=$(git rev-parse --short=7 HEAD 2>/dev/null || echo "unknown")
          if [ "$GIT_HASH" != "unknown" ]; then
            DEV_VERSION="${BASE_VERSION}-dev-g${GIT_HASH}"
          else
            DEV_VERSION="${BASE_VERSION}-dev"
          fi
          # For SonarQube, use base version only (clean semantic version)
          echo "dev_version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "sonar_version=$BASE_VERSION" >> $GITHUB_OUTPUT
      - name: Run formatter
        run: devbox run formatter
      - name: Run tests with coverage
        run: devbox run go test -v -covermode=set -coverprofile=coverage.out ./...
      - name: Run linter
        run: devbox run linter
      - name: Build CLI
        run: devbox run build-cli
      - name: SonarQube Scan
        # Skip for dependabot PRs (they don't have access to secrets)
        if: github.actor != 'dependabot[bot]'
        uses: SonarSource/sonarqube-scan-action@v2
        with:
          args: >
            -Dsonar.projectVersion=${{ steps.version.outputs.sonar_version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
